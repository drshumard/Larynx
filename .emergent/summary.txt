<analysis>**original_problem_statement:**
The user wants to build a full-stack application named Larynx TTS.

**PRODUCT REQUIREMENTS:**
1.  **Core Functionality:** Convert long text into a single MP3 file using the ElevenLabs TTS API.
2.  **Dual-Mode TTS:** The application must support two selectable methods for audio generation:
    *   **Chunking Mode:** Manually split long text, process each chunk via the ElevenLabs TTS API, and concatenate the resulting audio files. This mode must support a configurable chunk size (500-20,000 characters).
    *   **Studio Mode:** Use the ElevenLabs Studio API to process long-form content in a single workflow.
3.  **Pronunciation Dictionary:** Support the use of ElevenLabs Pronunciation Dictionaries by allowing a Dictionary ID and Version ID to be configured in the settings.
4.  **Frontend UI:**
    *   An enterprise-grade SaaS interface for submitting and monitoring jobs.
    *   A dashboard to display all jobs with their status.
    *   A dedicated job details page for each job.
5.  **Persistent Settings:**
    *   A settings modal that allows the user to configure all TTS parameters for both Chunking and Studio modes, including pronunciation dictionaries. Settings must be saved persistently in the database.
6.  **Webhook Integration:**
    *   On job completion, send a webhook to a configured URL.
    *   The system must accept arbitrary flat key-value data from the initial API request (e.g., , , ) and pass this data through to the final webhook payload.
7.  **Google Drive Upload:**
    *   The API request can include a  for a Google Drive folder.
    *   If  is provided, the final generated audio file must be uploaded to that specific Google Drive folder. The webhook payload should then include the URL to the file in Google Drive.
8.  **Production Deployment:**
    *   The application must be deployable to a Lightsail server at a specific domain () in the  directory.
    *   The deployment must use  for the backend process and  as a reverse proxy for the frontend and API.
    *   The deployment process must be managed by a simple shell script ().
    *   All configurable parameters (domain, ports, API keys, DB credentials) must be exposed in a  file.
9.  **File Management:**
    *   A cron job must be set up to automatically delete generated audio files from the server's local storage after 48 hours to conserve space.

**User's preferred language**: English

**what currently exists?**
A full-stack FARM (FastAPI, React, MongoDB) application. The backend supports dual-mode TTS (Chunking & Studio), persistent settings, pronunciation dictionaries, and custom webhook data. The frontend is a React SPA with a dashboard and job detail views.

A complete  and  based deployment system has been created with scripts (, ) located in the  directory. This system is designed to run on the user's Lightsail server, handling backend processes via  and serving the frontend as static files via . It also includes a cron job for cleaning up old audio files.

The logic for uploading completed audio files to Google Drive using a service account has been added to the backend.

**Last working item**:
The agent was implementing the Google Drive upload feature.

- **Last item agent was working:** The agent was debugging the newly added Google Drive upload functionality. After adding the necessary libraries (), creating the upload logic in , and saving the user-provided service account credentials, a test on the local development server failed. The log  indicated that the backend could not find the credentials file. The agent identified that the path in the local  file was incorrect and was in the process of fixing it.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** backend testing agent. The agent needs to create a new job via a  command, providing a . Then, it must verify the backend logs for successful upload messages and check the final webhook payload to ensure it contains the .
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1:** (P0) Finalize and Test Google Drive Upload Feature.
- **Issue 2:** (P1) Stabilize and Verify Production Deployment.

**Issues Detail:**
- **Issue 1:** Finalize and Test Google Drive Upload Feature.
  - **Attempted fixes:** The agent has written all the necessary backend code in , installed dependencies, and saved the credentials file. The last action was attempting to fix the credentials file path for the local development environment.
  - **Next debug checklist:**
    1.  Ensure the  in  points correctly to .
    2.  Restart the backend service.
    3.  Create a new job via the API, including a valid .
    4.  Monitor backend logs () for Uploading to Google Drive..., Upload successful, and the resulting file URL.
    5.  Verify that the webhook sent upon completion includes the  field in its payload.
  - **Why fix this issue and what will be achieved with the fix?** This will complete the final feature request from the user, making the application feature-complete according to the latest requirements.
  - **Status:** IN PROGRESS
  - **Is recurring issue?** N
  - **Should Test frontend/backend/both after fix?** backend
  - **Blocked on other issue:** None

- **Issue 2:** Stabilize and Verify Production Deployment.
  - **Attempted fixes:** The deployment process has been a major challenge, with numerous failed attempts due to port conflicts, user permissions ( vs. ), PM2 configuration errors, and most recently, MongoDB authentication failures. The agent has created several iterations of deployment scripts, culminating in [0;31mDo not run as root. Run as ubuntu user.[0m and . The last known blocker was a MongoDB authentication error ().
  - **Next debug checklist:**
    1.  The user needs to confirm that they have correctly created a MongoDB user and database and have updated the production  file with the correct  (including user, password, and ) and .
    2.  Once the  is confirmed correct, the user should run the  script again.
    3.  Check  for any new errors.
    4.  If the backend runs successfully, perform a health check () and then test the full application via the public domain.
  - **Why fix this issue and what will be achieved with the fix?** This will resolve a long-standing and frustrating series of problems, finally getting the application running in the user's target production environment.
  - **Status:** BLOCKED (User confirmation of DB credentials pending)
  - **Is recurring issue?** Y
  - **Should Test frontend/backend/both after fix?** both
  - **Blocked on other issue:** None

**In progress Task List**:
There are no tasks separate from the issues listed above.

**Upcoming and Future Tasks**
There are no new features requested. The entire focus is on completing the Google Drive integration and achieving a stable production deployment.

**Completed work in this session**
- **Configurable Chunk Size:** Added a setting to control the character size for text chunking.
- **Pronunciation Dictionary:** Implemented and debugged support for ElevenLabs Pronunciation Dictionaries.
- **Production Deployment Scripts:** Created and iteratively debugged a full deployment system using , , and shell scripts for a Lightsail server.
- **Audio File Cleanup:** Implemented a cron job via the deployment script to delete audio files older than 48 hours.
- **Webhook Data Refactor:** Changed the custom webhook data from a nested object to flat key-value pairs to support the user's n8n workflow.
- **PostHog Removal:** Removed the PostHog tracking snippet from .
- **Google Drive Integration (Initial):** Added Python libraries and backend logic for uploading files to Google Drive.

**Earlier issues found/mentioned but not fixed**
All major issues have been addressed or are currently in progress. The deployment saga has been the most significant, with each specific error being fixed sequentially.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork:** Deployment has been a recurring nightmare. The agent has repeatedly provided scripts that failed on the user's specific environment due to unforeseen issues like user permissions, port conflicts with another running application, and incorrect assumptions about the MongoDB setup.
- **Recurrence count:** At least 5 major iterations of debugging the deployment.
- **Status:** IN PROGRESS

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, Motor, , Uvicorn
- **Frontend:** React, Craco
- **Database:** MongoDB
- **Deployment:** PM2 (for process management), Nginx (as reverse proxy), Cron (for scheduled cleanup), Bash scripting.
- **3rd Party APIs:** ElevenLabs, Google Drive API (via service account).

**key DB schema**
-   **collection**: 
    -   **document structure**: 
-   **collection**: 
    -   **document structure**: 

**changes in tech stack**
-  and its dependencies were added for Google Drive integration.

**All files of reference**
-   : Heavily modified to add Google Drive upload logic, update webhook data structures, and handle new environment variables for deployment.
-   : **Newly Created**. Contains the Google Cloud service account key.
-   [0;31mDo not run as root. Run as ubuntu user.[0m: **Newly Created/Modified**. The primary script for deploying updates.
-   : **Newly Created/Modified**. A utility script for complete re-installation.
-   : **Newly Created**. A wrapper script to solve PM2's inability to directly run Python virtual environment commands.
-   : **Newly Created/Modified**. Nginx site configuration.
-   : Modified to remove the PostHog tracking script.

**Areas that need refactoring**:
-   Both  and  are extremely monolithic and difficult to maintain. They should be broken down into smaller, more focused modules and components.
-   The deployment scripts have been patched together through many debug cycles and could be simplified and made more robust.

**key api endpoints**
-   : Creates a new job. Now accepts , , , and .
-   : Lists existing jobs.
-   : Updates the TTS settings.

**Critical Info for New Agent**
- **Deployment is fragile.** The user has another app running on the same server with a similar stack. Pay close attention to user permissions (run as ), port conflicts (backend must run on a non-conflicting port, currently ), and Nginx configurations.
- **MongoDB requires authentication.** The user's production MongoDB is not open. The  and  variables in  MUST be set correctly with valid credentials for the application to start. This has been the source of the most recent errors.
- The immediate next step is to finish debugging the Google Drive upload feature, which is coded but failed its first local test due to a pathing issue.

**documents and test reports created in this job**
- Multiple deployment-related scripts and configuration files have been created in the  directory.

**Last 10 User Messages and any pending HUMAN messages**
1.  : (Sends new test job to dev URL)
2.  : Confirms the job ran but did not have the new  because the code wasn't deployed yet.
3.  : n8n can't send nested data. Change  to be flat key-value pairs.
4.  : Implements the change to flat key-value pairs.
5.  : Add a  to the request and upload the final audio to that Google Drive folder.
6.  : Asks for clarification on Google Drive auth (Service Account vs. OAuth).
7.  : (Uploads a service account JSON file).
8.  : Acknowledges the credentials and begins implementing the GDrive upload feature.
9.  : (Writes all code, installs dependencies, saves credentials).
10. : Reports the local test failed because the credentials path was wrong and is now fixing it.

**Project Health Check:**
-   **Broken:**
    -   The production deployment is non-functional due to persistent MongoDB authentication errors that the user needs to resolve in their  file.
    -   The new Google Drive upload feature is not yet verified and failed its initial local test.
-   **Mocked:** None.

**3rd Party Integrations**
-   **ElevenLabs API:** Requires a user-provided API key.
-   **Google Drive API:** Uses a user-provided Service Account JSON file for authentication.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** None.

**Credentials to test flow:**
-   **ElevenLabs API Key:** Located in .
-   **Google Drive Service Account:** Located in .
-   **MongoDB Credentials:** The user must provide these for the production environment in  on their server.

**What agent forgot to execute**
- The agent repeatedly failed to create a working deployment script for the user's specific environment, leading to a long and frustrating back-and-forth. Key environmental details (user permissions, port usage, DB auth) were overlooked in initial attempts.
- The agent initially missed the  tracking script in  after the user asked for it to be removed, which caused user frustration. It has since been removed.</analysis>
